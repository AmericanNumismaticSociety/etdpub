<html xmlns="http://www.w3.org/1999/xhtml" xmlns:xforms="http://www.w3.org/2002/xforms" xmlns:xs="http://www.w3.org/2001/XMLSchema" xmlns:ev="http://www.w3.org/2001/xml-events"
	xmlns:xxforms="http://orbeon.org/oxf/xml/xforms" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:fr="http://orbeon.org/oxf/xml/form-runner" xmlns:mods="http://www.loc.gov/mods/v3"
	xmlns:xi="http://www.w3.org/2001/XInclude">
	<head>
		<title>Edit ETD</title>
		<link rel="stylesheet" href="/fr/style/bootstrap/css/bootstrap.css" type="text/css" />
		<link rel="stylesheet" href="/fr/style/form-runner-bootstrap-override.css" type="text/css" />

		<link rel="stylesheet" href="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" />
		<script type="text/javascript" src="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
		<link rel="shortcut icon" href="/ops/images/orbeon-icon-16.ico" />
		<link rel="icon" href="/ops/images/orbeon-icon-16.png" type="image/png" />
		<link rel="stylesheet" href="/apps/etdpub/xforms/css/style.css" />

		<!-- model -->
		<xforms:model>
			<xforms:instance id="doc" xxforms:exclude-result-prefixes="#all">
				<modsCollection xmlns="http://www.loc.gov/mods/v3" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
					xsi:schemaLocation="http://www.loc.gov/mods/v3 http://www.loc.gov/standards/mods/mods.xsd">
					<mods version="3.5">
						<titleInfo>
							<title></title>
						</titleInfo>
						<name>
							<namePart></namePart>
						</name>
						<abstract></abstract>
						<genre valueUri="http://vocab.getty.edu/aat/300028029">dissertations</genre>
						<originInfo>
							<publisher></publisher>
							<dateCreated></dateCreated>
						</originInfo>
						<language>
							<languageTerm>en</languageTerm>
						</language>
						<physicalDescription>
							<internetMediaType></internetMediaType>
						</physicalDescription>
						<location>
							<url></url>
						</location>
						<accessCondition xlink:type="simple" xlink:href="http://creativecommons.org/licenses/by-nc/4.0">Attribution-NonCommercial CC BY-NC</accessCondition>
						<recordInfo>
							<recordContentSource>American Numismatic Society</recordContentSource>
							<recordCreationDate encoding="iso8601"></recordCreationDate>
							<recordIdentifier></recordIdentifier>
						</recordInfo>
					</mods>
				</modsCollection>
			</xforms:instance>

			<xforms:instance id="exist-config">
				<xi:include href="../exist-config.xml"></xi:include>
			</xforms:instance>
			<!-- load URLs from config.xml in eXist into form for Solr and CSS file -->
			<xforms:instance id="config">
				<config xmlns=""></config>
			</xforms:instance>

			<xforms:instance id="control-instance" xxforms:exclude-result-prefixes="#all">
				<controls xmlns="">
					<status></status>
					<id></id>
					<media_url></media_url>
				</controls>
			</xforms:instance>

			<xforms:instance id="languages">
				<xi:include href="instances/languages.xml"></xi:include>
			</xforms:instance>

			<xforms:instance id="licenses">
				<licenses xmlns="">
					<license value="http://creativecommons.org/licenses/by-nc/4.0">Attribution-NonCommercial CC BY-NC</license>
				</licenses>
			</xforms:instance>

			<!-- upload instances -->
			<xforms:instance id="file">
				<!-- Start with placeholders for three files -->
				<file xmlns="" xsi:type="xs:anyURI" filename="" mediatype="" size="" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"></file>
			</xforms:instance>

			<xforms:instance id="generator-config">
				<config xmlns="">
					<url></url>
					<mode>binary</mode>
					<content-type></content-type>
				</config>
			</xforms:instance>

			<xforms:instance id="serializer-config">
				<config xmlns="">
					<url></url>
				</config>
			</xforms:instance>

			<xforms:instance id="delete-config">
				<config xmlns="">
					<delete>
						<url></url>
					</delete>
				</config>
			</xforms:instance>

			<xforms:instance id="dump">
				<dump xmlns=""></dump>
			</xforms:instance>

			<!-- Solr instances -->
			<xforms:instance id="addIndex">
				<add xmlns=""></add>
			</xforms:instance>
			<xforms:instance id="sendCommit">
				<commit></commit>
			</xforms:instance>			

			<!-- ************************* BINDINGS ************************** -->
			<xforms:bind nodeset="instance('doc')/mods:mods">
				<xforms:bind nodeset="mods:titleInfo/mods:title" required="true()"></xforms:bind>
				<xforms:bind nodeset="mods:name/mods:namePart" required="true()"></xforms:bind>
				<xforms:bind nodset="mods:abstract" required="true()"/>
				<xforms:bind nodeset="mods:originInfo">
					<xforms:bind nodeset="mods:dateCreated" required="true()" type="xs:gYear"></xforms:bind>
					<xforms:bind nodeset="mods:publisher" required="true()"></xforms:bind>
				</xforms:bind>
				<xforms:bind nodeset="mods:location/mods:url" required="true()"></xforms:bind>
				<xforms:bind nodeset="mods:language/mods:languageTerm" required="true()"></xforms:bind>
				<xforms:bind nodeset="mods:recordInfo">
					<xforms:bind nodeset="mods:recordIdentifier" required="true()" type="xs:anyURI"></xforms:bind>
				</xforms:bind>
			</xforms:bind>

			<!-- **************** MODEL-CONSTRUCT-DONE ********************** -->
			<xforms:action ev:event="xforms-model-construct-done">
				<xforms:send submission="load-config"></xforms:send>

				<!-- load id if parameter is passed -->
				<xforms:action if="string(xxforms:get-request-parameter('id'))">
					<xforms:setvalue ref="instance('doc')/mods:mods/mods:recordInfo/mods:recordIdentifier" value="xxforms:get-request-parameter('id')"></xforms:setvalue>
					<xforms:setvalue ref="instance('control-instance')/id" value="xxforms:get-request-parameter('id')"></xforms:setvalue>
					<xforms:send submission="load-doc"/>
				</xforms:action>
				<!-- if the record is new -->
				<xforms:action if="not(string(xxforms:get-request-parameter('id')))">
					<xforms:setvalue ref="instance('doc')/mods:mods/mods:recordInfo/mods:recordCreationDate" value="format-date(current-date(), '[Y0001]-[M01]-[D01]')"></xforms:setvalue>
				</xforms:action>
			</xforms:action>

			<!-- ************************* SUBMISSIONS ************************** -->
			<!-- *** eXist *** -->
			<xforms:submission id="load-config" serialization="none" method="get" action="{instance('exist-config')/url}etdpub/config.xml" replace="instance" instance="config"
				xxforms:username="{instance('exist-config')/username}" xxforms:password="{instance('exist-config')/password}"></xforms:submission>

			<xforms:submission id="load-doc" serialization="none" method="get" action="{instance('exist-config')/url}etdpub/mods/{instance('doc')/mods:mods/mods:recordInfo/mods:recordIdentifier}.xml"
				replace="instance" instance="doc" xxforms:username="{instance('exist-config')/username}" xxforms:password="{instance('exist-config')/password}">
				<xforms:message ev:event="xforms-submit-error" level="modal">Unable to load MODS record from eXist.</xforms:message>
			</xforms:submission>

			<xforms:submission id="save-doc" ref="instance('doc')" action="{instance('exist-config')/url}etdpub/mods/{instance('doc')/mods:mods/mods:recordInfo/mods:recordIdentifier}.xml" method="put"
				replace="none" xxforms:username="{instance('exist-config')/username}" xxforms:password="{instance('exist-config')/password}">
				<xforms:message ev:event="xforms-submit-error" level="modal">Error Saving Documents. Be sure all required inputs are filled in.</xforms:message>
				
				<!-- publish to Solr -->
				<xforms:action ev:event="xforms-submit-done">
					<xforms:setvalue ref="instance('control-instance')/status">Successfully saved MODS record to eXist.</xforms:setvalue>
				</xforms:action>
			</xforms:submission>

			<!-- *** SOLR *** -->			
			<xforms:submission id="mods-to-solr" method="get" replace="instance" instance="addIndex" serialization="none" resource="/etdpub/id/{instance('control-instance')/id}.solr">
				<xforms:message ev:event="xforms-submit-error" level="modal">Error transforming MODS record to Solr document.</xforms:message>
				<xforms:send ev:event="xforms-submit-done" submission="post-solr-doc"/>
			</xforms:submission>
			
			<xforms:submission id="post-solr-doc" action="{instance('config')/solr}update" ref="instance('addIndex')" instance="addIndex" replace="instance" method="post">
				<xforms:message ev:event="xforms-submit-error" level="modal">Data Failed to POST to Solr. Index may be offline or URL is incorrect.</xforms:message>
				<xforms:action ev:event="xforms-submit-done">
					<xforms:setvalue ref="instance('control-instance')/status">Document successfully saved to Solr.</xforms:setvalue>
					<xforms:send submission="submit-commit"></xforms:send>
				</xforms:action>
			</xforms:submission>

			<!-- send commit -->
			<xforms:submission id="submit-commit" action="{instance('config')/solr}update" ref="instance('sendCommit')" instance="sendCommit" replace="none" method="post">
				<xforms:action ev:event="xforms-submit-error">
					<xforms:message level="modal">Failed to commit to Solr index.</xforms:message>					
				</xforms:action>
			</xforms:submission>
		</xforms:model>
	</head>

	<body>
		<div class="container-fluid">
			<div class="row">
				<div class="col-md-12">
					<p><a href="../"><span class="glyphicon glyphicon-arrow-left"></span>Return to Admin</a></p>
					<xforms:group ref=".[string-length(instance('control-instance')/status) &gt; 0]">
						<div class="bg-info alert-box">
							<span class="glyphicon glyphicon-info-sign"></span>
							<strong>Status:</strong>
							<xforms:output ref="instance('control-instance')/status"></xforms:output>
						</div>
					</xforms:group>
					<div class="submission">
						<xforms:submit submission="save-doc">
							<xforms:label><span class="glyphicon glyphicon-floppy-disk"></span>Save</xforms:label>
						</xforms:submit>
						<xforms:submit submission="load-doc">
							<xforms:label><span class="glyphicon glyphicon-refresh"></span>Load</xforms:label>
						</xforms:submit>
					</div>
					<h1>Edit Metadata</h1>
				</div>
				<xforms:group ref="instance('doc')/mods:mods">
					<div class="col-md-6">
						<div>
							<xforms:input ref="mods:titleInfo/mods:title">
								<xforms:label>Title</xforms:label>
								<xforms:alert>Required</xforms:alert>
								<xforms:action ev:event="xforms-value-changed">
									<xforms:var name="title" select="."></xforms:var>
									<!-- set the id, only if it was previously blank (new file) -->
									<xforms:setvalue ref="instance('doc')/mods:mods/mods:recordInfo/mods:recordIdentifier" value="replace(lower-case($title), '\s', '_')"
										if="not(string(instance('doc')/mods:mods/mods:recordInfo/mods:recordIdentifier))"></xforms:setvalue>
								</xforms:action>
							</xforms:input>
						</div>
						<div>
							<xforms:input ref="mods:name/mods:namePart">
								<xforms:label>Author</xforms:label>
								<xforms:alert>Required</xforms:alert>
							</xforms:input>
						</div>
						<div>
							<xforms:input ref="mods:originInfo/mods:publisher">
								<xforms:label>University</xforms:label>
								<xforms:alert>Required</xforms:alert>
							</xforms:input>
						</div>
						<div>
							<xforms:input ref="mods:originInfo/mods:dateCreated">
								<xforms:label>Date</xforms:label>
								<xforms:alert>Required. Must be a year.</xforms:alert>
							</xforms:input>
						</div>
						<div>
							<xforms:select1 ref="mods:language/mods:languageTerm">
								<xforms:label>Language</xforms:label>
								<xforms:item>
									<xforms:label>Select...</xforms:label>
									<xforms:value></xforms:value>
								</xforms:item>
								<xforms:itemset nodeset="instance('languages')/language">
									<xforms:label ref="."></xforms:label>
									<xforms:value ref="@value"></xforms:value>
								</xforms:itemset>
								<xforms:alert>Required</xforms:alert>
							</xforms:select1>
						</div>
						<div>
							<xforms:select1 ref="mods:accessCondition/@xlink:href">
								<xforms:label>Rights</xforms:label>
								<xforms:itemset nodeset="instance('licenses')/license">
									<xforms:label ref="."></xforms:label>
									<xforms:value ref="@value"></xforms:value>
								</xforms:itemset>
								<xforms:action ev:event="xforms-value-changed">
									<xforms:var name="label" select="."></xforms:var>
									<xforms:setvalue ref="instance('doc')/mods:accessCondition" value="$label"></xforms:setvalue>
								</xforms:action>
							</xforms:select1>
						</div>
						<div>
							<xforms:textarea ref="mods:abstract">
								<xforms:label>Abstract</xforms:label>
								<xforms:alert>Required</xforms:alert>
							</xforms:textarea>
						</div>
					</div>
					<div class="col-md-6">
						<xforms:group ref=".[string(mods:location/mods:url)]">
							<div class="subsection">
								<h2>Media <small>
										<xforms:trigger appearance="minimal">
											<xforms:label><span class="glyphicon glyphicon-new-window"></span></xforms:label>
											<xforms:action ev:event="DOMActivate">
												<xforms:setvalue ref="instance('control-instance')/media_url" value="concat(instance('config')/url, instance('doc')/mods:mods/mods:location/mods:url)"></xforms:setvalue>
												<xforms:load ref="instance('control-instance')/media_url"></xforms:load>
											</xforms:action>
										</xforms:trigger>
										<xforms:trigger appearance="minimal">
											<xforms:label><span class="glyphicon glyphicon-remove"></span></xforms:label>
											<xforms:dispatch ev:event="DOMActivate" target="delete-dialog" name="fr-show"></xforms:dispatch>
										</xforms:trigger>
									</small>
								</h2>
								<div>
									<xforms:output ref="mods:location/mods:url">
										<xforms:label>URL</xforms:label>
									</xforms:output>
								</div>
								<div>
									<xforms:output ref="mods:physicalDescription/mods:internetMediaType">
										<xforms:label>Content Type</xforms:label>
									</xforms:output>
								</div>
							</div>
						</xforms:group>
						<xforms:group ref=".[not(string(mods:location/mods:url))]">
							<div class="subsection">
								<h2>Upload Media</h2>
								<fr:upload ref="instance('file')">
									<xforms:filename ref="@filename"></xforms:filename>
									<xforms:mediatype ref="@mediatype"></xforms:mediatype>
									<xxforms:size ref="@size"></xxforms:size>
								</fr:upload>
								<br />
								<fr:button>
									<xforms:label>Upload</xforms:label>
									<xforms:action ev:event="DOMActivate">
										<xforms:send submission="upload-file"></xforms:send>
										<!--get the temp file written to disk, and move it into the docs folder in the etdpub app directory -->
										<xforms:action ev:event="xforms-submit-done">
											<xforms:setvalue ref="instance('generator-config')/url" value="instance('file')"></xforms:setvalue>
											<xforms:setvalue ref="instance('generator-config')/content-type" value="instance('file')/@mediatype"></xforms:setvalue>
											<xforms:setvalue ref="instance('serializer-config')/url" value="concat('oxf:/apps/etdpub/docs/', instance('file')/@filename)"></xforms:setvalue>
											<xforms:insert nodeset="instance('dump')"
												origin="xxforms:call-xpl('oxf:/apps/etdpub/xpl/xforms/move-file.xpl', ('generator-config', 'serializer-config'), (instance('generator-config'), instance('serializer-config')), 'data')"></xforms:insert>
											<!-- set the data within the MODS document -->
											<xforms:setvalue ref="instance('doc')/mods:mods/mods:location/mods:url" value="concat('docs/', instance('file')/@filename)"></xforms:setvalue>
											<xforms:setvalue ref="instance('doc')/mods:mods/mods:physicalDescription/mods:internetMediaType" value="instance('file')/@mediatype"></xforms:setvalue>
										</xforms:action>
									</xforms:action>
								</fr:button>
							</div>
						</xforms:group>
						<xforms:group ref="mods:recordInfo">
							<div class="subsection">
								<h2>Record Info</h2>
								<div>
									<xforms:output ref="mods:recordIdentifier">
										<xforms:label>ID</xforms:label>
										<xforms:alert>Required</xforms:alert>
									</xforms:output>
								</div>
								<div>
									<xforms:output ref="mods:recordCreationDate">
										<xforms:label>Creation Date</xforms:label>
										<xforms:alert>Required</xforms:alert>
									</xforms:output>
								</div>
							</div>
						</xforms:group>
					</div>
				</xforms:group>
			</div>
		</div>

		<fr:alert-dialog id="delete-dialog">
			<fr:label>Delete Document</fr:label>
			<fr:message>Are you sure you want to delete the document file?</fr:message>
			<fr:positive-choice>
				<fr:label>Yes</fr:label>
				<xforms:action ev:event="DOMActivate">
					<!-- delete the file -->
					<xforms:setvalue ref="instance('delete-config')/delete/url" value="concat('oxf:/apps/etdpub/', instance('doc')/mods:mods/mods:location/mods:url)"></xforms:setvalue>
					<xforms:insert nodeset="instance('dump')" origin="xxforms:call-xpl('oxf:/apps/etdpub/xpl/xforms/delete-id.xpl', 'configuration', instance('delete-config'), 'data')"></xforms:insert>
					<!-- blank the URL and mime type -->
					<xforms:setvalue ref="instance('doc')/mods:mods/mods:location/mods:url"></xforms:setvalue>
					<xforms:setvalue ref="instance('doc')/mods:mods/mods:physicalDescription/mods:internetMediaType"></xforms:setvalue>
				</xforms:action>
			</fr:positive-choice>
			<fr:negative-choice>
				<fr:label>No</fr:label>
			</fr:negative-choice>
		</fr:alert-dialog>

		<fr:xforms-inspector></fr:xforms-inspector>
	</body>
</html>
