<?xml version="1.0" encoding="utf-8"?>
<!--
    Copyright (C) 2015 Ethan Gruber
    etdpub: https://github.com/ewg118/etdpub
    Apache License 2.0
-->
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:xforms="http://www.w3.org/2002/xforms" xmlns:xs="http://www.w3.org/2001/XMLSchema" xmlns:ev="http://www.w3.org/2001/xml-events"
	xmlns:xxforms="http://orbeon.org/oxf/xml/xforms" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:fr="http://orbeon.org/oxf/xml/form-runner" xmlns:xlink="http://www.w3.org/1999/xlink"
	xmlns:oxf="http://www.orbeon.com/oxf/processors" xmlns:exist="http://exist.sourceforge.net/NS/exist" xmlns:mods="http://www.loc.gov/mods/v3">
	<head>
		<title>etdpub Administration</title>
		<link rel="stylesheet" href="/fr/style/bootstrap/css/bootstrap.css" type="text/css" />
		<link rel="stylesheet" href="/fr/style/form-runner-bootstrap-override.css" type="text/css" />

		<link rel="stylesheet" href="http://netdna.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" />
		<script type="text/javascript" src="http://netdna.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
		<link rel="shortcut icon" href="/ops/images/orbeon-icon-16.ico" />
		<link rel="icon" href="/ops/images/orbeon-icon-16.png" type="image/png" />
		<link rel="stylesheet" href="/apps/etdpub/xforms/css/style.css" />

		<xforms:model>
			<!-- exist URL is stored in an XML file -->
			<xforms:instance id="exist-config">
				<xi:include href="../exist-config.xml"></xi:include>
			</xforms:instance>

			<xforms:instance id="control-instance">
				<controls xmlns="">
					<id></id>
					<media_url></media_url>
				</controls>
			</xforms:instance>

			<xforms:instance id="config" xxforms:exclude-result-prefixes="#all">
				<config></config>
			</xforms:instance>

			<xforms:instance id="config-template" xxforms:exclude-result-prefixes="#all">
				<config>
					<title>etdpub</title>
					<url>http://localhost:8080/orbeon/etdpub/</url>
					<solr>
						<url>http://localhost:8080/solr4.10/etdpub/</url>
						<rows>20</rows>
					</solr>
					<absolute_path>/usr/local/projects/etdpub/</absolute_path>
				</config>
			</xforms:instance>

			<xforms:instance id="doc" xxforms:exclude-result-prefixes="#all">
				<eac-cpf xmlns=""></eac-cpf>
			</xforms:instance>

			<!-- xquery -->
			<xforms:instance id="eXist-xquery">
				<exist:query xmlns="">
					<exist:text></exist:text>
				</exist:query>
			</xforms:instance>

			<xforms:instance id="xqueries">
				<queries xmlns="">
					<query id="collection-count">&lt;report&gt;{count(collection())}&lt;/report&gt;</query>
					<query id="get-objects">declare namespace mods="http://www.loc.gov/mods/v3"; declare namespace tei="http://www.tei-c.org/ns/1.0"; &lt;report> { for $record in collection() let $type := $record/*/local-name() return if ($type='modsCollection') then &lt;record> &lt;type>mods&lt;/type> &lt;id>{
						data($record//mods:recordIdentifier) }&lt;/id> &lt;title>{ data($record//mods:title) }&lt;/title>&lt;author>{ data($record//mods:namePart) }&lt;/author> &lt;date>{
						data($record//mods:dateCreated) }&lt;/date> &lt;media_url&gt;{ data($record//mods:location/mods:url) }&lt;/media_url&gt;&lt;type&gt;MODS&lt;/type&gt; &lt;/record> else if ($type='TEI') then &lt;record>
					&lt;type>{ lower-case($type) }&lt;/type> &lt;id>{ data($record/*[local-name()='TEI']/@xml:id) }&lt;/id> &lt;title>{
					data($record//tei:titleStmt/tei:title) }&lt;/title>&lt;type&gt;TEI&lt;/type&gt; &lt;/record> else '' } &lt;/report> </query>
					
					<!--<query id="get-objects"> declare namespace mods="http://www.loc.gov/mods/v3"; declare namespace tei="http://www.tei-c.org/ns/1.0"; &lt;report> { for $record in collection() return &lt;record> &lt;title&gt;
						{data($record//mods:title)}&lt;/title&gt; &lt;id>{data($record//mods:recordIdentifier) }&lt;/id> &lt;author>{ data($record//mods:namePart) }&lt;/author> &lt;date>{
						data($record//mods:dateCreated) }&lt;/date> &lt;media_url&gt;{ data($record//mods:location/mods:url) }&lt;/media_url&gt; &lt;/record> } &lt;/report> </query>-->
				</queries>
			</xforms:instance>

			<xforms:instance id="pagination-result">
				<exist:result></exist:result>
			</xforms:instance>

			<xforms:instance id="xquery-result">
				<exist:result></exist:result>
			</xforms:instance>

			<!-- file operations (for deleting the document from the filesystem -->
			<xforms:instance id="delete-config">
				<config xmlns="">
					<delete>
						<url></url>
					</delete>
				</config>
			</xforms:instance>

			<xforms:instance id="dump">
				<dump xmlns=""></dump>
			</xforms:instance>

			<!-- send to Solr -->
			<xforms:instance id="addIndex" xxforms:exclude-result-prefixes="#all">
				<add xmlns=""></add>
			</xforms:instance>

			<!-- Instance for Solr commit-->
			<xforms:instance id="sendCommit" xxforms:exclude-result-prefixes="#all">
				<commit></commit>
			</xforms:instance>
			<!-- delete from Solr -->
			<xforms:instance id="deleteId" xxforms:exclude-result-prefixes="#all">
				<delete xmlns="">
					<query></query>
				</delete>
			</xforms:instance>

			<!-- submissions -->
			<xforms:submission id="load-config" serialization="none" method="get" action="{instance('exist-config')/url}etdpub/config.xml" replace="instance" instance="config"
				xxforms:username="{instance('exist-config')/username}" xxforms:password="{instance('exist-config')/password}">
				<xforms:action ev:event="xforms-submit-done">
					<xforms:setvalue ref="instance('eXist-xquery')/exist:text" value="instance('xqueries')/query[@id='get-objects']"></xforms:setvalue>
					<xforms:send submission="xquery-pagination"></xforms:send>
				</xforms:action>
				<xforms:message ev:event="xforms-submit-error" level="modal">Error loading config from eXist database.</xforms:message>
			</xforms:submission>

			<!--***************** XQUERY ******************-->
			<!-- xquery for getting and processing query results into pages of items -->
			<xforms:submission id="xquery-pagination" ref="instance('eXist-xquery')" action="{instance('exist-config')/url}etdpub/records" method="post" replace="instance" instance="pagination-result"
				xxforms:username="{instance('exist-config')/username}" xxforms:password="{instance('exist-config')/password}">
				<xforms:message ev:event="xforms-submit-error" level="modal">Error querying eXist database.</xforms:message>
			</xforms:submission>

			<xforms:submission id="xquery-collection" ref="instance('eXist-xquery')" action="{instance('exist-config')/url}etdpub/records" method="post" replace="instance" instance="xquery-result"
				xxforms:username="{instance('exist-config')/username}" xxforms:password="{instance('exist-config')/password}">
				<xforms:message ev:event="xforms-submit-error" level="modal">Error querying eXist database.</xforms:message>
			</xforms:submission>

			<!--***************** EXIST-DB ******************-->
			<!-- delete finding aid -->
			<xforms:submission id="delete-doc" action="{instance('exist-config')/url}etdpub/records/{instance('control-instance')/id}.xml" method="delete" replace="none"
				xxforms:username="{instance('exist-config')/username}" xxforms:password="{instance('exist-config')/password}">
				<xforms:setvalue ev:event="xforms-submit-done" ref="instance('control-instance')/status">MODS record successfully deleted.</xforms:setvalue>
				<xforms:message ev:event="xforms-submit-error" level="modal">Error deleting document from eXist database.</xforms:message>
			</xforms:submission>

			<!-- ************************* SOLR ************************** -->
			<!-- delete from Solr -->
			<xforms:submission id="delete-solr-doc" action="{instance('config')/solr/url}update" ref="instance('deleteId')" instance="deleteId" replace="none" method="post">
				<xforms:send ev:event="xforms-submit-done" submission="commit"></xforms:send>
				<xforms:message ev:event="xforms-submit-error" level="modal">Data Failed to POST to Solr.</xforms:message>
			</xforms:submission>

			<!-- send commit -->
			<xforms:submission id="commit" action="{instance('config')/solr/url}update" ref="instance('sendCommit')" instance="sendCommit" replace="none" method="post">
				<xforms:message ev:event="xforms-submit-error" level="modal">Solr commit failed.</xforms:message>
			</xforms:submission>

			<!-- load etdpub config file on xforms construction -->
			<xforms:action ev:event="xforms-model-construct-done">
				<xforms:send submission="load-config"></xforms:send>
			</xforms:action>
		</xforms:model>
	</head>

	<body>
		<xforms:var name="display_path">../</xforms:var>
		<div class="container-fluid">
			<div class="row">
				<div class="col-md-12">
					<div id="form">
						<xforms:group ref="instance('status')/text()">
							<div class="bg-info alert-box">
								<span class="glyphicon glyphicon-info-sign"></span>
								<strong>Status:</strong>
								<xforms:output ref="instance('status')"></xforms:output>
							</div>
						</xforms:group>
						<h1>etdpub Administration</h1>
						<p><a href="{instance('config')/url}" target="_blank">View Pubic Interface <span class="glyphicon glyphicon-new-window"></span></a></p>
						<h3>Create New Documents</h3>
						<ul>
							<xforms:repeat nodeset="instance('config')/templates/template">
								<li><a href="edit/?template={@id}"><span class="glyphicon glyphicon-file"></span><xforms:output ref="."></xforms:output></a></li>
							</xforms:repeat>
						</ul>
						<xforms:group ref=".[count(instance('pagination-result')//record) &gt; 0]">
							<div>
								<h3>List of Records</h3>
								<!-- pagination variables -->
								<xforms:var name="numFound" select="number(instance('control-instance')/numFound)"></xforms:var>
								<table class="table">
									<thead>
										<tr>
											<th>Type</th>
											<th>Title</th>
											<th style="width:10%">View</th>
											<th style="width:5%">Delete</th>
										</tr>
									</thead>
									<tbody>
										<xforms:repeat nodeset="instance('pagination-result')//record">
											<xforms:var name="id" select="id"></xforms:var>
											<xforms:var name="media_url" select="media_url"></xforms:var>
											<tr>
												<td><xforms:output ref="type"/></td>
												<td>
													<h4>
														<a href="edit/?id={$id}">
															<xforms:output ref="title"></xforms:output>
														</a>
													</h4>
													<div>
														<xforms:output ref="author">
															<xforms:label>Author</xforms:label>
														</xforms:output>
													</div>
													<div>
														<xforms:output ref="date">
															<xforms:label>Date</xforms:label>
														</xforms:output>
													</div>
												</td>
												<td class="text-center">
													<a href="{instance('config')/url}id/{$id}.xml" target="_blank">xml</a> | <a href="{instance('config')/url}id/{$id}" target="_blank">html</a>
												</td>
												<td class="text-center">
													<xforms:trigger appearance="minimal">
														<xforms:label>
															<span class="glyphicon glyphicon-remove"></span>
														</xforms:label>
														<xforms:action ev:event="DOMActivate">
															<xforms:setvalue ref="instance('control-instance')/id" value="$id"></xforms:setvalue>
															<xforms:setvalue ref="instance('control-instance')/media_url" value="$media_url"></xforms:setvalue>
															<xforms:dispatch target="delete" name="fr-show"></xforms:dispatch>
														</xforms:action>
													</xforms:trigger>
												</td>
											</tr>
										</xforms:repeat>
									</tbody>
								</table>
							</div>
						</xforms:group>
						<xforms:group ref=".[count(instance('pagination-result')//record)=0]">
							<h1>No records in collection.</h1>
						</xforms:group>
					</div>
					<!-- dialogs -->
					<fr:alert-dialog id="delete">
						<fr:label>Delete</fr:label>
						<fr:message>Are you sure you want to delete this object?</fr:message>
						<fr:negative-choice></fr:negative-choice>
						<fr:positive-choice>
							<xforms:action ev:event="DOMActivate">
								<!-- first delete the uploaded media -->
								<xforms:setvalue ref="instance('delete-config')/delete/url" value="concat('oxf:/apps/etdpub/', instance('control-instance')/media_url)"></xforms:setvalue>
								<xforms:insert nodeset="instance('dump')"
									origin="xxforms:call-xpl('oxf:/apps/etdpub/xpl/xforms/delete-document.xpl', 'configuration', instance('delete-config'), 'data')"></xforms:insert>
								<!-- delete the doc from eXist and Solr -->
								<xforms:send submission="delete-doc"></xforms:send>
								<xforms:setvalue ref="instance('deleteId')/query" value="concat('id:&#x022;', instance('control-instance')/id, '&#x022;')"></xforms:setvalue>
								<xforms:send submission="delete-solr-doc"></xforms:send>
								<!-- reload table -->
								<xforms:setvalue ref="instance('eXist-xquery')/exist:text" value="instance('xqueries')/query[@id='get-objects']"></xforms:setvalue>
								<xforms:send submission="xquery-pagination"></xforms:send>
							</xforms:action>
						</fr:positive-choice>
					</fr:alert-dialog>
					<!--<fr:xforms-inspector id="orbeon-xforms-inspector"></fr:xforms-inspector>-->
				</div>
			</div>
		</div>
	</body>
</html>
